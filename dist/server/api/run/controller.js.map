{"version":3,"sources":["api/run/controller.js"],"names":["dbStream","require","Controller","db","parser","cache","hookParser","ready","collection","bind","clear","on","data","set","CAN_Id","req","res","isPaused","sendStatus","database","resume","status","send","collectionName","unpipe","pause","specification","save","query","parseInt","has","get","module","exports"],"mappings":";;;;;;;;;;;;;;;;AAAA,IAAIA,WAAWC,QAAQ,sBAAR,CAAf;;IACMC,U;AACF,wBAAYC,EAAZ,EAAeC,MAAf,EAAsB;AAAA;;AAClB,aAAKD,EAAL,GAAUA,EAAV;AACA,aAAKC,MAAL,GAAcA,MAAd;AACA,aAAKC,KAAL,GAAa,mBAAb;AACA,aAAKC,UAAL,CAAgB,KAAKF,MAArB;AACA,aAAKD,EAAL,CAAQI,KAAR,CAAc,YAAU;AACpB,iBAAKC,UAAL,GAAkB,KAAKL,EAAL,CAAQK,UAA1B;AACH,SAFa,CAEZC,IAFY,CAEP,IAFO,CAAd;AAGH;;;;oCACW;AACR,mBAAO,KAAKD,UAAZ;AACH;;;mCACUJ,M,EAAO;AACd,iBAAKC,KAAL,CAAWK,KAAX;AACAN,mBAAOO,EAAP,CAAU,MAAV,EAAiB,UAASC,IAAT,EAAc;AAC3B,qBAAKP,KAAL,CAAWQ,GAAX,CAAeD,KAAKE,MAApB,EAA4BF,IAA5B;AACH,aAFgB,CAEfH,IAFe,CAEV,IAFU,CAAjB;AAGH;;;8BACKM,G,EAAIC,G,EAAI;AACV,gBAAG,CAAC,KAAKZ,MAAL,CAAYa,QAAZ,EAAJ,EAA2B;AACvBD,oBAAIE,UAAJ,CAAe,GAAf;AACA;AACH;AACD,gBAAIC,WAAW,IAAInB,QAAJ,EAAf;AACA,iBAAKI,MAAL,CAAYgB,MAAZ;AACA,iBAAKd,UAAL,CAAgB,KAAKF,MAArB;AACAe,qBAASZ,KAAT,CAAe,YAAU;AACrB,qBAAKC,UAAL,GAAkBW,SAASX,UAA3B;AACAQ,oBAAIK,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBH,SAASX,UAAT,CAAoBe,cAAzC;AACH,aAHc,CAGbd,IAHa,CAGR,IAHQ,CAAf;AAIA,iBAAKN,EAAL,GAAUgB,QAAV;AACH;;;6BACIJ,G,EAAKC,G,EAAK;AACX,iBAAKZ,MAAL,CAAYoB,MAAZ;AACA,iBAAKpB,MAAL,CAAYqB,KAAZ;AACA,iBAAKrB,MAAL,CAAYsB,aAAZ,GAA4B,EAA5B;AACA,iBAAKvB,EAAL,CAAQwB,IAAR;AACA,iBAAKtB,KAAL,CAAWK,KAAX;AACAM,gBAAIK,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,SAArB;AACH;;;gCACOP,G,EAAIC,G,EAAI;AACZ,gBAAG,KAAKZ,MAAL,CAAYa,QAAZ,EAAH,EAA2BD,IAAIK,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,SAArB,EAA3B,KACK,IAAG,KAAKnB,EAAL,IAAS,KAAKA,EAAL,CAAQK,UAAjB,IAA6B,KAAKL,EAAL,CAAQK,UAAR,CAAmBe,cAAnD,EAAmEP,IAAIK,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,KAAKnB,EAAL,CAAQK,UAAR,CAAmBe,cAAxC,EAAnE,KACD;AACAP,oBAAIM,IAAJ,CAAS,MAAT;AACH;AACJ;;;6BACIP,G,EAAIC,G,EAAI;AACT,gBAAG,CAACD,IAAIa,KAAJ,CAAUd,MAAd,EAAqB;AACjBE,oBAAIE,UAAJ,CAAe,GAAf;AACA;AACH;AACDH,gBAAIa,KAAJ,CAAUd,MAAV,GAAmBe,SAASd,IAAIa,KAAJ,CAAUd,MAAnB,CAAnB;AACA,gBAAG,CAAC,KAAKT,KAAL,CAAWyB,GAAX,CAAef,IAAIa,KAAJ,CAAUd,MAAzB,CAAJ,EAAsCE,IAAIE,UAAJ,CAAe,GAAf,EAAtC,KACI;AACAF,oBAAIM,IAAJ,CAAS,KAAKjB,KAAL,CAAW0B,GAAX,CAAehB,IAAIa,KAAJ,CAAUd,MAAzB,CAAT;AACH;AACJ;;;;;AAELkB,OAAOC,OAAP,GAAiB/B,UAAjB","file":"controller.js","sourcesContent":["var dbStream = require('../../db/dbStream.js');\r\nclass Controller{\r\n    constructor(db,parser){\r\n        this.db = db;\r\n        this.parser = parser;\r\n        this.cache = new Map();\r\n        this.hookParser(this.parser);\r\n        this.db.ready(function(){\r\n            this.collection = this.db.collection;\r\n        }.bind(this));\r\n    }\r\n    getActive() {\r\n        return this.collection;\r\n    }\r\n    hookParser(parser){\r\n        this.cache.clear();\r\n        parser.on('data',function(data){\r\n            this.cache.set(data.CAN_Id, data);\r\n        }.bind(this));\r\n    }\r\n    start(req,res){\r\n        if(!this.parser.isPaused()){\r\n            res.sendStatus(401);\r\n            return;\r\n        } \r\n        var database = new dbStream();\r\n        this.parser.resume();\r\n        this.hookParser(this.parser);\r\n        database.ready(function(){\r\n            this.collection = database.collection;            \r\n            res.status(200).send(database.collection.collectionName);\r\n        }.bind(this));\r\n        this.db = database;\r\n    }\r\n    stop(req, res) {\r\n        this.parser.unpipe();\r\n        this.parser.pause();\r\n        this.parser.specification = [];\r\n        this.db.save();\r\n        this.cache.clear();\r\n        res.status(200).send(\"Stopped\");\r\n    }\r\n    current(req,res){\r\n        if(this.parser.isPaused()) res.status(200).send(\"Stopped\");\r\n        else if(this.db&&this.db.collection&&this.db.collection.collectionName) res.status(200).send(this.db.collection.collectionName);\r\n        else{\r\n            res.send(\"demo\")\r\n        }\r\n    }\r\n    last(req,res){\r\n        if(!req.query.CAN_Id){\r\n            res.sendStatus(404);\r\n            return;\r\n        }\r\n        req.query.CAN_Id = parseInt(req.query.CAN_Id);\r\n        if(!this.cache.has(req.query.CAN_Id)) res.sendStatus(404);\r\n        else{\r\n            res.send(this.cache.get(req.query.CAN_Id));\r\n        }\r\n    }\r\n}\r\nmodule.exports = Controller;"]}