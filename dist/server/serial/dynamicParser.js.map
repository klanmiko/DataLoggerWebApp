{"version":3,"sources":["serial/dynamicParser.js"],"names":["stream","require","Q","Descriptor","Validator","parseStream","options","objectMode","self","start","Date","getTime","onload","model","find","err","array","console","error","specification","map","set","CAN_Id","log","done","load","chunk","encoding","next","transformed","fcall","parse","bind","then","value","push","catch","process","env","NODE_ENV","data","out","i","length","getValue","slice","dataType","subDataType","offset","subLength","getDecimal","toString","preStartIndex","Math","floor","preShift","getArray","getFlag","getState","spec","forEach","index","key","generics","Array","object","Object","description","Timestamp","raw","get","beginParsing","deferred","defer","resolve","chooseParser","promise","Transform","module","exports"],"mappings":"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","file":"dynamicParser.js","sourcesContent":["var stream = require('stream');\r\nvar Q = require('q');\r\nvar Descriptor = require('../api/db/parse_descriptor.js');\r\nvar Validator = require('../api/db/validator.js');\r\nclass parseStream extends stream.Transform{ //ES6 Javascript is now just Java, apparently\r\n    constructor(options) {\r\n        options = options || {};\r\n        options.objectMode = true;\r\n        super(options);\r\n        var self = this;\r\n        var start = new Date().getTime();\r\n        Descriptor.onload = function() {\r\n            Descriptor.model.find({}, function(err, array) {\r\n                if(err) console.error(err);\r\n                self.specification = new Map();\r\n                for(let map of array) {\r\n                    self.specification.set(map.CAN_Id, map);\r\n                }\r\n                console.log(\"db load: \" + (new Date().getTime() - start));\r\n            })\r\n        }\r\n        if(options && options.done)\r\n            this.load.done(function() {\r\n                options.done();\r\n            });\r\n    }\r\n    _transform(chunk, encoding, next) {\r\n        var transformed = Q.fcall(this.parse.bind(this), chunk);\r\n        transformed.then(function(value)\r\n        {\r\n            this.push(value);\r\n        }.bind(this)).catch(function(err){\r\n            if(process.env.NODE_ENV==\"development\"){\r\n                if(err) console.error(err);\r\n                console.error(\"missing some parser\");\r\n            }\r\n        }.bind(this))\r\n        .done();\r\n        next();\r\n    }\r\n    getArray(data,map){\r\n        var out = [];\r\n        for(var i=0;i<map.length;i++){\r\n            out.push(this.getValue(data.slice(),\r\n                {dataType:map.array.subDataType,\r\n                    offset:map.offset+i*map.array.subLength,\r\n                    length:map.array.subLength\r\n                }));\r\n        }\r\n        return out;\r\n    }\r\n    getString(data,map){\r\n        return this.getDecimal(data,map).toString();\r\n    }\r\n    getDecimal(data,map){\r\n        var out = 0;\r\n        var offset = map.offset;\r\n        var length = map.length;\r\n        var preStartIndex = Math.floor(map.offset/8)+2;\r\n        var preShift = map.offset%8;\r\n        for(var i=0;i<preShift;i++){\r\n            data[preStartIndex]&=0x7F;\r\n            data[preStartIndex] = data[preStartIndex]<<1;\r\n        }\r\n        data[preStartIndex] = data[preStartIndex]>>preShift;\r\n        offset -= preShift;\r\n        length += preShift; \r\n        while(length>0){\r\n            out = out<<1;\r\n            out |= ((data[Math.floor(offset/8)+2]&0x80)>>7);\r\n            data[Math.floor(offset/8)+2] = data[Math.floor(offset/8)+2]<<1;\r\n            offset++;\r\n            length--;\r\n        }\r\n        return out;        \r\n    }\r\n    getFlag(data,map){\r\n        var out = [];\r\n        var value = 0;\r\n        var length = map.length;\r\n        var offset = map.offset;\r\n        while(length>0){\r\n            value = value<<8;\r\n            value |= data[Math.floor(offset/8)+2];\r\n            offset+=8;\r\n            length-=8;\r\n        }\r\n        length = map.length;\r\n        out.push(value==0);\r\n        while(length>0){\r\n            out.push((value&0x01)==0x01);\r\n            value = value>>1;\r\n            length--;\r\n        }\r\n        return out;\r\n    }\r\n    getState(data,map){\r\n        var out=0;\r\n        var length = map.length;\r\n        var offset = map.offset;\r\n        //console.log(map);\r\n        while(length>0){\r\n            out = out<<8;\r\n            out |= data[Math.floor(offset/8)+2];\r\n            offset+=8;\r\n            length-=8;\r\n        }\r\n        return out;\r\n    }\r\n    getValue(data,map){\r\n        switch(map.dataType){\r\n            case \"array\":\r\n                return this.getArray(data,map);\r\n            case \"decimal\":\r\n                return this.getDecimal(data,map);\r\n            case \"flag\":\r\n                return this.getFlag(data,map);\r\n            case \"state\":\r\n                return this.getState(data,map);\r\n        }\r\n    }\r\n    beginParsing(out,data,spec){\r\n        var self = this;\r\n        spec.map.forEach(function(value,index,array){\r\n            if(value.key){\r\n                out[value.key] = self.getValue(data.slice(),value);\r\n            }\r\n            else{\r\n                if(!out.generics) out.generics = new Array();\r\n                var object = new Object();\r\n                object.description = value.description;\r\n                object.dataType = value.dataType;\r\n                if(value.dataType == 'array') object.subDataType = value.array.subDataType;\r\n                object.value = self.getValue(data.slice(),value);\r\n                out.generics.push(object);\r\n            }\r\n        });\r\n        return out;\r\n    }\r\n    chooseParser(data){\r\n        var self = this;\r\n        var out = new Object();\r\n        out.CAN_Id = data[0];\r\n        out.Timestamp = data[1];\r\n        out.raw = new Array();\r\n        for(var i=2;i<data.length;i++){\r\n            out.raw.push(data[i].toString(16));\r\n        }\r\n        var spec = this.specification || new Map();\r\n        var map = spec.get(data[0]) || {CAN_Id: data[0], map:[]};\r\n        return this.beginParsing(out, data, map);\r\n        //console.log(\"looking up database\");\r\n    }\r\n    parse(data) {\r\n        if(data&&data.length>0){\r\n            var deferred = Q.defer();\r\n            setImmediate(function() {\r\n                deferred.resolve(Q.fcall(this.chooseParser.bind(this), data));\r\n            }.bind(this));\r\n            return deferred.promise;\r\n        }\r\n        else return \"\";\r\n    }\r\n}\r\nmodule.exports = parseStream;"]}